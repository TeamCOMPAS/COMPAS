name: COMPAS compile test

on:
  workflow_dispatch: # allow manual triggering of this workflow
  pull_request:
    branches: [dev]
    paths: 
      - 'src/**'
      - '.github/workflows/compas-compile-ci.yml'
      - 'misc/cicd-scripts/**'
      - 'misc/examples/methods_paper_plots/detailed_evolution/**'
      - 'compas_python_utils/**'
      - 'py_tests/**'

jobs:
  compas:
    name: Build COMPAS
    runs-on: ${{ matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, macos-12]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8'
          cache: 'pip'
        if: (startsWith(matrix.os, 'macos')) || (startsWith(matrix.os, 'ubuntu-2'))
      
      - name: Cache brew deps on macos
        id: cache-homebrew-packages
        uses: actions/cache@v3
        if: startsWith(matrix.os, 'macos') 
        with:
          path: |
            /usr/local/Homebrew
            /usr/local/Cellar
            /usr/local/Frameworks
            /usr/local/bin
            /usr/local/opt
          key: macos-12-build-cache-${{ hashFiles('./scripts/builder_setup.sh') }}-v2

      # This step will run only on ubuntu
      - name: Install dependencies on ubuntu
        if: startsWith(matrix.os, 'ubuntu-2') 

        run: |
          cd misc/cicd-scripts
          chmod 755 linux-dependencies
          ./linux-dependencies

      # This step will run only on centos 7 container on ubuntu-18.04
      - name: Install dependencies on centos docker container
        if: startsWith(matrix.container, 'centos')
        run: |
          cd utils/cicd-scripts
          chmod 755 centos-dependencies
          ./centos-dependencies
      
      # This step will run only on macos
      - name: Install dependencies on macos
        if: startsWith(matrix.os, 'macos')
        run: |
          cd misc/cicd-scripts
          chmod 755 macos-dependencies
          ./macos-dependencies

      - name: Link macos deps if it was a cache hit
        if: startsWith(matrix.os, 'macos') && steps.cache-homebrew-packages.outputs.cache-hit == 'true'
        run: |
          brew link gsl
          brew link boost
          brew link hdf5
          brew link texlive

      # This step will run only on all runners
      - name: Build Compas
        run: |
          cd src && make -j $(nproc) -f Makefile
          ./COMPAS -v

      - name: Install python + run example COMPAS job
        run: |
          pip install -e .[dev]
          export COMPAS_ROOT_DIR=${GITHUB_WORKSPACE}
          cd ${GITHUB_WORKSPACE}/misc/examples/methods_paper_plots/detailed_evolution
          chmod 755 run.sh
          cat run.sh
          ./run.sh


      - name: Run pytests
        if: startsWith(matrix.os, 'ubuntu-2')
        # Run tests and collect coverage data
        run: |
          cd ${GITHUB_WORKSPACE}
          export COMPAS_ROOT_DIR=${GITHUB_WORKSPACE}
          pytest --cov=compas_python_utils/ py_tests/
          coverage html
          coverage-badge -o coverage_badge.svg -f

      - name: Archive code coverage results
        if: startsWith(matrix.os, 'ubuntu-2')
        uses: actions/upload-artifact@v3
        with:
          name: code-coverage
          path: |
            htmlcov/
            coverage_badge.svg


      - name: Archive COMPAS run data
        if: startsWith(matrix.os, 'ubuntu-2')
        uses: actions/upload-artifact@v3
        with:
          name: COMPAS-run-artifacts
          path: |
            py_tests/test_artifacts
