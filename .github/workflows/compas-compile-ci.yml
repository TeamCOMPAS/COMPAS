name: COMPAS compile test

on: [pull_request]

jobs:
  compas:
    name: Build COMPAS
    # runs-on: ubuntu-18.04
    runs-on: ${{ matrix.os}}
    strategy:
      matrix:
        # os: [ubuntu-18.04, ubuntu-20.04, macos-latest]
        os: [macos-latest]
    steps:
      - uses: actions/checkout@v2

      # - name: Install dependencies on ubuntu
      #   if: startsWith(matrix.os, 'ubuntu')
      #   run: |
      #     sudo apt install texlive-latex-extra cm-super dvipng
      #     sudo apt update && sudo apt install g++ libboost-all-dev libgsl-dev libhdf5-serial-dev 
          
      - name: Install dependencies on macos
        if: startsWith(matrix.os, 'macos')
        run: |
          /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
          brew --version
          brew install gsl
          brew install boost
          brew install hdf5

      # - name: Build Compas
      #   run: |
      #     cd src && make -j $(nproc) -f Makefile
      #     ./COMPAS -v

      # - name: Install Python and required packages on Ubuntu
      #   if: startsWith(matrix.os, 'ubuntu')
      #   run: |
      #     # sudo apt-get install python3.8 python3.8-dev python3.8-distutils python3.8-venv
      #     # python3.8 -m venv dev3.8
      #     # source dev3.8/bin/activate
      #     sudo apt-get install gcc libpq-dev -y
      #     # sudo apt-get install python-dev  python-pip -y
      #     sudo apt-get install python3-dev python3-pip python3-venv python3-wheel -y
      #     pip3 install --upgrade setuptools
      #     pip3 install wheel
      #     pip3 install -r requirements.txt

      - name: Install Python and required packages using MacPorts
        if: startsWith(matrix.os, 'macos')
        run: |
          /usr/bin/xcodebuild -version
          sudo xcode-select --install
          sudo port -v selfupdate
          # curl -O https://github.com/macports/macports-base/releases/download/v2.7.2/MacPorts-2.7.2-11-BigSur.pkg
          # pwd
          # installer -pkg ${GITHUB_WORKSPACE}/MacPorts-2.7.2-11-BigSur.pkg -target CurrentUserHomeDirectory

          
          # curl -O https://distfiles.macports.org/MacPorts/MacPorts-2.7.2.tar.bz2
          # tar xf MacPorts-2.7.2.tar.bz2
          # cd MacPorts-2.7.2/
          # ./configure
          # make
          # sudo make install

          port --version
          port install python36
          sudoport select --set python3 python36
          port install py36-pip
          select --set pip36
          pip3 install -r requirements.txt
      
      # - name: Run Post-Processing Python Scripts
      #   if: startsWith(matrix.os, 'ubuntu')
      #   run: |
      #     export COMPAS_ROOT_DIR=${GITHUB_WORKSPACE}
      #     cd utils/example_plots/methods_paper_plots/detailed_evolution
      #     python3 runSubmitDemo.py
      #     python3 plot_detailed_evolution.py

      - name: Finish Job
        run: echo 'All done and dusted'