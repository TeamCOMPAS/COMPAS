name: COMPAS compile test

on: [pull_request]

jobs:
  compas:
    name: Build COMPAS
    runs-on: ${{ matrix.os}}
    # container: ${{matrix.container}}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-18.04, ubuntu-20.04, macos-11]
        include: 
          - os: ubuntu-18.04
            container: 'centos:7'

    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies on ubuntu
        if: startsWith(matrix.os, 'ubuntu-20.04')
        run: |
          sudo apt install texlive-latex-extra cm-super dvipng
          sudo apt update && sudo apt install g++ libboost-all-dev libgsl-dev libhdf5-serial-dev 

      - name: Install dependencies on centos docker container
        if: startsWith(matrix.container, 'centos')
        run: |
          yum clean all
          rm -rf /var/cache/yum/*
          yum makecache
          # cd /etc/yum.repos.d/
          # sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
          # sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
          yum update -y
          yum -y install epel-release
          yum -y install boost boost-thread boost-devel
          yum -y install gsl
          yum -y install hdf5
          yum -y group install "Development Tools"
          
      - name: Install dependencies on macos
        if: startsWith(matrix.os, 'macos')
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          export PATH="/usr/local/opt/python/libexec/bin:$PATH"
          brew --version
          brew install gsl
          brew install boost
          brew install hdf5
          brew install mactex
          eval "$(/usr/libexec/path_helper)"
          export PATH="/usr/local/texlive:/Library/TeX/texbin:$PATH"
          echo $PATH
          pdflatex --version
          brew install ghostscript
          sudo tlmgr update --self
          sudo tlmgr install dvipng
          sudo tlmgr install texliveonfly
          sudo tlmgr install environ
          sudo tlmgr install adjustbox
          sudo tlmgr install tcolorbox
          sudo tlmgr install collectbox
          sudo tlmgr install ucs
          sudo tlmgr install trimspaces
          sudo tlmgr install titling
          sudo tlmgr install enumitem
          sudo tlmgr install rsfs


      - name: Build Compas
        run: |
          cd src && make -j $(nproc) -f Makefile
          ./COMPAS -v
        env:
          nproc: 4

      - name: Install Python and required packages on Ubuntu
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get install gcc libpq-dev -y
          sudo apt-get install python3-dev python3-pip python3-venv python3-wheel -y
          pip3 install --upgrade setuptools
          pip3 install wheel
          pip3 install -r requirements.txt

      - name: Install Python and required packages on MacOS
        if: startsWith(matrix.os, 'macos')
        run: |
          python3 -m pip install -r requirements.txt

      - name: Run Post-Processing Python Scripts
        run: |
          export COMPAS_ROOT_DIR=${GITHUB_WORKSPACE}
          cd utils/example_plots/methods_paper_plots/detailed_evolution
          python3 runSubmitDemo.py
          python3 plot_detailed_evolution.py

      - name: Finish Job
        run: echo 'All done and dusted'