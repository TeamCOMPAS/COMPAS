name: COMPAS compile test

on: [pull_request]

jobs:
  compas:
    name: Build COMPAS
    runs-on: ${{ matrix.os}}
    container: ${{matrix.container}}  # to run the job on centos 7 docker image which runs on ubuntu-18.04 machine
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04]  # runners(virtual machines) to run the job on
        # include: # add the combination to run the centos container only on ubuntu-18.04
        #   - os: ubuntu-18.04
        #     container: 'centos:7'

    steps:
      - uses: actions/checkout@v2

      # This step will run only on ubuntu-20.04
      - name: Install dependencies on ubuntu
        if: startsWith(matrix.os, 'ubuntu-20') 
        run: |
          cd utils/cicd-scripts
          # chmod Development755 linux-dependencies
          # ls -alt
          ./linux-dependencies

      # This step will run only on centos 7 container on ubuntu-18.04
      - name: Install dependencies on centos docker container
        if: startsWith(matrix.container, 'centos')
        run: |
          cd utils/cicd-scripts
          # chmod Development755 centos-dependencies
          # ls -alt
          ./centos-dependencies
      
      # This step will run only on macos
      - name: Install dependencies on macos
        if: startsWith(matrix.os, 'macos')
        run: |
          cd utils/cicd-scripts
          # chmod Development755 macos-dependencies
          # ls -alt
          ./macos-dependencies

      # This step will run only on all runners
      - name: Build Compas
        run: |
          cd src && make -j $(nproc) -f Makefile
          ./COMPAS -v
        env:
          nproc: 4

      # This step will run only on all runners
      - name: Install Python packages
        run: |
          python3 -m pip install -r requirements.txt

      # This step will run on all runners
      - name: Run Post-Processing Python Scripts
        run: |
          export COMPAS_ROOT_DIR=${GITHUB_WORKSPACE}
          cd utils/example_plots/methods_paper_plots/detailed_evolution
          python3 runSubmitDemo.py
          python3 plot_detailed_evolution.py
